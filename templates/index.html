<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iodine Content Lookup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Iodine Content Lookup</h1>
        <p class="subtitle">Search common foods for their iodine content (mcg per serving)</p>
    </header>

    <main>
        <section id="tab-search" class="tab-panel active">
            <div class="search-container">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search for a food (e.g. milk, salmon, egg)..."
                    autocomplete="off"
                >
            </div>

            <div class="categories">
                <h2>Browse by Category</h2>
                <select id="category-select" class="category-select">
                    <option value="">Select a category</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="results-section" class="results-section hidden">
                <div class="results-header">
                    <h2 id="results-title">Results</h2>
                    <button id="clear-btn" class="clear-btn">Clear</button>
                </div>
                <div class="table-wrap">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Food</th>
                                <th>Iodine (mcg/serving)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
                <p id="no-results" class="no-results hidden">No foods found.</p>
            </div>
        </section>

        <section id="tab-tracker" class="tab-panel">
            <div id="tracker-section" class="tracker-section">
                <div class="results-header">
                    <div>
                        <h2>Today's Tracker</h2>
                        <p id="tracker-date" class="tracker-date"></p>
                    </div>
                    <button id="clear-tracker-btn" class="clear-btn">Clear Today</button>
                </div>
                <div class="tracker-summary">
                    <div class="summary-card">
                        <span class="summary-label">Total Iodine</span>
                        <span id="summary-total" class="summary-value">0</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Items</span>
                        <span id="summary-count" class="summary-value">0</span>
                    </div>
                </div>
                <div class="tracker-progress">
                    <div class="progress-header">
                        <span class="progress-label">Daily Threshold</span>
                        <span id="progress-text" class="progress-text">0 / 150 mcg</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="progress-note" class="progress-note hidden">Above 150 mcg daily allowance.</p>
                </div>
                <div id="tracker-alert" class="tracker-alert hidden"></div>
                <div class="table-wrap">
                    <table id="tracker-table">
                        <thead>
                            <tr>
                                <th>Food</th>
                                <th># Servings</th>
                                <th>Serving Size</th>
                                <th>Iodine (mcg)</th>
                                <th>Remove</th>
                            </tr>
                        </thead>
                        <tbody id="tracker-body"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="tracker-total-label">Total Iodine</td>
                                <td id="tracker-total" class="tracker-total-value">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <p id="tracker-empty" class="no-results">No items tracked yet.</p>
            </div>
        </section>

        <section id="tab-about" class="tab-panel">
            <div class="about-card">
                <h2>About This App</h2>
                <p class="about-text">
                    This tool helps you quickly look up iodine content in common foods
                    and track a daily total in a lightweight, session-based tracker.
                </p>
                <p class="about-text">
                    Low-iodine diets are often temporary and used for specific medical
                    situations; this app helps you estimate iodine intake from everyday foods.
                </p>
                <a class="about-link" href="https://github.com/elcap123/lid_lookup" target="_blank" rel="noreferrer">
                    View the project on GitHub
                </a>
            </div>

            <div class="about-card">
                <h2>Data Attribution</h2>
                <ul class="about-list">
                    <li>
                        Source: U.S. Department of Agriculture, Agricultural Research Service (USDA-ARS)
                    </li>
                    <li>
                        Dataset: USDA, FDA, and ODS-NIH Database for the Iodine Content of Common Foods,
                        Release 4.0 (2024)
                    </li>
                    <li>
                        Downloaded from the USDA ARS Iodine page and documented in the official release PDF
                    </li>
                </ul>
                <div class="about-links">
                    <a href="https://www.ars.usda.gov/northeast-area/beltsville-md-bhnrc/beltsville-human-nutrition-research-center/methods-and-application-of-food-composition-laboratory/mafcl-site-pages/iodine/" target="_blank" rel="noreferrer">
                        USDA ARS Iodine Page
                    </a>
                    <a href="https://www.ars.usda.gov/ARSUserFiles/80400535/Data/Iodine/IODINE_DATABASE_RELEASE_4_DOCUMENTATION.pdf" target="_blank" rel="noreferrer">
                        Release 4.0 Documentation
                    </a>
                </div>
            </div>
        </section>

        <nav class="tab-bar" aria-label="Primary">
            <button class="tab-btn active" data-tab="search">Search</button>
            <button class="tab-btn" data-tab="tracker">Tracking (<span id="tracking-count">0</span>)</button>
            <button class="tab-btn" data-tab="about">About</button>
        </nav>
    </main>

    <script>
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const searchInput = document.getElementById('search-input');
        const resultsSection = document.getElementById('results-section');
        const resultsTitle = document.getElementById('results-title');
        const resultsBody = document.getElementById('results-body');
        const noResults = document.getElementById('no-results');
        const clearBtn = document.getElementById('clear-btn');
        const categorySelect = document.getElementById('category-select');
        const trackerBody = document.getElementById('tracker-body');
        const trackerTable = document.getElementById('tracker-table');
        const trackerTotal = document.getElementById('tracker-total');
        const trackerEmpty = document.getElementById('tracker-empty');
        const clearTrackerBtn = document.getElementById('clear-tracker-btn');
        const trackerDate = document.getElementById('tracker-date');
        const trackerAlert = document.getElementById('tracker-alert');
        const summaryTotal = document.getElementById('summary-total');
        const summaryCount = document.getElementById('summary-count');
        const trackingCount = document.getElementById('tracking-count');
        const progressText = document.getElementById('progress-text');
        const progressFill = document.getElementById('progress-fill');
        const progressNote = document.getElementById('progress-note');

        let debounceTimer;
        let currentLocalDate = getLocalDateString();
        let trackerItemCount = 0;

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveTab(btn.dataset.tab);
            });
        });

        function setActiveTab(tabName) {
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
            tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === `tab-${tabName}`));
            document.body.classList.toggle('hide-header', tabName === 'tracker' || tabName === 'about');
        }

        function renderResults(foods, title) {
            resultsTitle.textContent = title;
            resultsBody.innerHTML = '';
            const atLimit = trackerItemCount >= 60;

            if (foods.length === 0) {
                noResults.classList.remove('hidden');
                document.getElementById('results-table').classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                document.getElementById('results-table').classList.remove('hidden');
                foods.forEach(food => {
                    const tr = document.createElement('tr');
                    const iodine = Number(food.iodine_mcg);
                    let levelLabel = 'High';
                    let levelClass = 'tag--high';
                    if (iodine <= 50) {
                        levelLabel = 'Low';
                        levelClass = 'tag--low';
                    } else if (iodine <= 150) {
                        levelLabel = 'Moderate';
                        levelClass = 'tag--medium';
                    }
                    tr.innerHTML = `
                        <td>${food.description}</td>
                        <td class="result-meta">
                            <span class="iodine-tag ${levelClass}">${food.iodine_mcg}</span>
                            <span class="result-divider">/</span>
                            <span class="result-serving">${food.serving_size} ${food.serving_measure}</span>
                        </td>
                        <td>
                            <button class="track-btn" data-food-id="${food.id}" ${atLimit ? 'disabled' : ''}>Add</button>
                            ${atLimit ? '<div class="inline-limit">Limit reached</div>' : ''}
                        </td>
                    `;
                    resultsBody.appendChild(tr);
                });
            }
            resultsSection.classList.remove('hidden');
            bindTrackButtons();
        }

        function clearResults() {
            resultsSection.classList.add('hidden');
            resultsBody.innerHTML = '';
            searchInput.value = '';
            categorySelect.value = '';
        }

        function bindTrackButtons() {
            const trackButtons = document.querySelectorAll('.track-btn');
            trackButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const foodId = Number(btn.dataset.foodId);
                    if (!Number.isFinite(foodId)) return;
                    apiPost('/api/tracker/add', { food_id: foodId, local_date: currentLocalDate })
                        .then(renderTrackerFromResponse)
                        .catch(showTrackerError);
                });
            });
        }

        function renderTrackerFromResponse(data) {
            trackerAlert.classList.add('hidden');
            trackerBody.innerHTML = '';
            trackerDate.textContent = data.date ? `Date: ${data.date}` : '';
            summaryTotal.textContent = `${data.total_iodine.toFixed(1)} mcg`;
            summaryCount.textContent = data.count;
            trackingCount.textContent = data.count;
            trackerItemCount = data.count;
            const goal = 150;
            const ratio = goal > 0 ? data.total_iodine / goal : 0;
            const percent = Math.min(ratio, 1) * 100;
            progressFill.style.width = `${percent}%`;
            progressText.textContent = `${data.total_iodine.toFixed(1)} / ${goal} mcg`;
            if (ratio > 1) {
                progressFill.classList.add('progress-fill--over');
                progressNote.classList.remove('hidden');
            } else {
                progressFill.classList.remove('progress-fill--over');
                progressNote.classList.add('hidden');
            }
            if (!data.items || data.items.length === 0) {
                trackerTable.classList.add('hidden');
                trackerEmpty.classList.remove('hidden');
                trackerTotal.textContent = '0';
                return;
            }

            trackerTable.classList.remove('hidden');
            trackerEmpty.classList.add('hidden');

            data.items.forEach((item) => {
                const tr = document.createElement('tr');
                const food = item.food;
                tr.innerHTML = `
                    <td>${food.description}</td>
                    <td>
                        <input type="number" min="0" step="1" class="quantity-input" value="${item.quantity}">
                    </td>
                    <td>${food.serving_size} ${food.serving_measure}</td>
                    <td class="iodine-value">${item.item_total.toFixed(1)}</td>
                    <td><button class="remove-btn">Remove</button></td>
                `;
                const qtyInput = tr.querySelector('.quantity-input');
                qtyInput.addEventListener('input', () => {
                    const nextVal = Number(qtyInput.value);
                    const safeVal = Number.isFinite(nextVal) ? nextVal : 0;
                    apiPost('/api/tracker/update', {
                        food_id: food.id,
                        quantity: safeVal,
                        local_date: currentLocalDate,
                    })
                        .then(renderTrackerFromResponse)
                        .catch(showTrackerError);
                });
                tr.querySelector('.remove-btn').addEventListener('click', () => {
                    apiPost('/api/tracker/remove', { food_id: food.id, local_date: currentLocalDate })
                        .then(renderTrackerFromResponse)
                        .catch(showTrackerError);
                });
                trackerBody.appendChild(tr);
            });

            trackerTotal.textContent = data.total_iodine.toFixed(1);
        }

        clearTrackerBtn.addEventListener('click', () => {
            apiPost('/api/tracker/clear', { local_date: currentLocalDate })
                .then(renderTrackerFromResponse)
                .catch(showTrackerError);
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const query = searchInput.value.trim();
            if (!query) {
                resultsSection.classList.add('hidden');
                return;
            }
            categorySelect.value = '';
            debounceTimer = setTimeout(() => {
                fetch(`/api/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => renderResults(data, `Search results for "${query}"`));
            }, 250);
        });

        categorySelect.addEventListener('change', () => {
            const category = categorySelect.value;
            if (!category) {
                resultsSection.classList.add('hidden');
                return;
            }
            searchInput.value = '';
            fetch(`/api/category/${encodeURIComponent(category)}`)
                .then(res => res.json())
                .then(data => renderResults(data, category));
        });

        clearBtn.addEventListener('click', clearResults);

        function apiPost(url, payload) {
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            }).then(res => {
                if (!res.ok) {
                    return res.json().then(err => Promise.reject(err));
                }
                return res.json();
            });
        }

        function apiGetTracker() {
            return fetch(`/api/tracker?local_date=${encodeURIComponent(currentLocalDate)}`)
                .then(res => res.json());
        }

        function showTrackerError(err) {
            const message = err && err.error ? err.error : 'Something went wrong.';
            trackerAlert.textContent = message;
            trackerAlert.classList.remove('hidden');
            setTimeout(() => trackerAlert.classList.add('hidden'), 3000);
        }

        function getLocalDateString() {
            const now = new Date();
            const tzOffsetMs = now.getTimezoneOffset() * 60000;
            return new Date(now - tzOffsetMs).toISOString().split('T')[0];
        }

        function refreshTrackerIfNeeded() {
            const nextDate = getLocalDateString();
            if (nextDate !== currentLocalDate) {
                currentLocalDate = nextDate;
            }
            apiGetTracker().then(renderTrackerFromResponse);
        }

        refreshTrackerIfNeeded();
        setInterval(refreshTrackerIfNeeded, 60000);
    </script>
</body>
</html>
